<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="智能客服系统架构设计 - 混合式用户画像提取架构">
    <title>系统架构 - 智能客服系统文档</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>智能客服系统</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">首页</a></li>
                <li><a href="user-profile.html" class="nav-link">用户画像</a></li>
                <li><a href="api-docs.html" class="nav-link">API 文档</a></li>
                <li><a href="architecture.html" class="nav-link active">系统架构</a></li>
                <li><a href="memory-filter.html" class="nav-link">智能记忆</a></li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <header class="doc-header">
        <div class="container">
            <h1 class="doc-title">系统架构</h1>
            <p class="doc-subtitle">混合式用户画像提取架构设计 - TrustCall 语义提取 + 数据统计计算的混合模式</p>
        </div>
    </header>

    <main class="doc-content">
        <div class="container">
            <section id="philosophy">
                <h2>📋 设计理念</h2>
                <p>根据业务需求，我们设计了用户画像提取架构，采用 <strong>TrustCall 语义提取 + 数据统计计算</strong> 的混合模式：</p>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="card-icon">🧠</div>
                        <h3>TrustCall</h3>
                        <p>仅用于提取需要语义理解的信息（情感、意图、关注点等）</p>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">📊</div>
                        <h3>数据分析</h3>
                        <p>用于统计、计算、聚合等可以通过数据处理得出的指标</p>
                    </div>
                    <div class="feature-card">
                        <div class="card-icon">🔄</div>
                        <h3>混合提取</h3>
                        <p>结合两者优势，确保画像的准确性和完整性</p>
                    </div>
                </div>
            </section>

            <section id="components">
                <h2>🏗️ 架构组件</h2>
                
                <h3>1. 语义提取组件 (TrustCall)</h3>
                
                <div class="quick-start-grid">
                    <div class="quick-start-item">
                        <h4>SemanticExtractionResult</h4>
                        <p>仅提取需要语义理解的信息：</p>
                        <ul>
                            <li><strong>language</strong>: 语言识别</li>
                            <li><strong>query_style</strong>: 提问风格分析</li>
                            <li><strong>sentiment</strong>: 情感倾向</li>
                            <li><strong>anxiety_level</strong>: 焦虑程度评估</li>
                            <li><strong>primary_concerns</strong>: 关注点识别</li>
                            <li><strong>pain_points</strong>: 痛点分析</li>
                            <li><strong>inferred_traveler_type</strong>: 旅客类型推断</li>
                        </ul>
                    </div>
                    
                    <div class="quick-start-item">
                        <h4>LongTermSemanticAnalysis</h4>
                        <p>长期语义趋势分析：</p>
                        <ul>
                            <li><strong>communication_style_evolution</strong>: 沟通风格演变</li>
                            <li><strong>concern_shift_patterns</strong>: 关注点变化</li>
                            <li><strong>core_needs</strong>: 核心需求识别</li>
                            <li><strong>personalization_recommendations</strong>: 个性化建议</li>
                        </ul>
                    </div>
                </div>

                <h3>2. 数据分析组件</h3>
                
                <div class="architecture-diagram">
                    <div class="arch-layer">
                        <h4>SessionMetricsCalculator - 会话指标计算</h4>
                        <div class="arch-components">
                            <span class="component">会话时长、轮次统计</span>
                            <span class="component">消息数量统计</span>
                            <span class="component">响应时间计算</span>
                            <span class="component">时间戳处理</span>
                        </div>
                        <p style="margin-top: 1rem; color: var(--text-secondary);">纯数据计算</p>
                    </div>
                    
                    <div class="arch-layer">
                        <h4>DataProfileAnalyzer - 数据画像分析</h4>
                        <div class="arch-components">
                            <span class="component">技术环境提取</span>
                            <span class="component">服务交互分析</span>
                            <span class="component">航班/路线/航司提取</span>
                            <span class="component">知识领域识别</span>
                            <span class="component">价值指标计算</span>
                        </div>
                        <p style="margin-top: 1rem; color: var(--text-secondary);">基于规则和模式匹配</p>
                    </div>
                    
                    <div class="arch-layer">
                        <h4>BehaviorAggregator - 行为聚合</h4>
                        <div class="arch-components">
                            <span class="component">每日交互指标计算</span>
                            <span class="component">行为模式统计</span>
                            <span class="component">服务使用统计</span>
                            <span class="component">长期趋势分析</span>
                        </div>
                        <p style="margin-top: 1rem; color: var(--text-secondary);">统计聚合</p>
                    </div>
                </div>

                <h3>3. 混合提取器</h3>
                
                <pre><code class="language-python">class HybridProfileExtractor:
    def __init__(self):
        # TrustCall 语义提取器
        self.semantic_extractor = create_extractor(...)
        
        # 数据分析组件
        self.data_analyzer = DataProfileAnalyzer()
        self.session_calculator = SessionMetricsCalculator()
        self.behavior_aggregator = BehaviorAggregator()</code></pre>
            </section>

            <section id="workflow">
                <h2>🔄 三步走流程</h2>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="card-icon">1️⃣</div>
                        <h3>第一步：会话画像提取</h3>
                        <pre><code class="language-python">async def extract_session_profile(self, ...):
    # 1. TrustCall 提取语义信息
    semantic_result = await self._extract_semantic_info(conversation_history)
    
    # 2. 计算会话统计指标
    session_metrics = self.session_calculator.calculate_session_metrics(...)
    
    # 3. 分析服务交互
    service_interaction = self.data_analyzer.analyze_service_interaction(...)
    
    # 4. 组装完整画像
    return SingleSessionProfile(...)</code></pre>
                    </div>
                    
                    <div class="feature-card">
                        <div class="card-icon">2️⃣</div>
                        <h3>第二步：每日聚合画像</h3>
                        <pre><code class="language-python">async def extract_daily_profile(self, ...):
    # 完全基于数据统计
    interaction_metrics = self.behavior_aggregator.calculate_daily_interaction_metrics(...)
    behavior_pattern = self.behavior_aggregator.analyze_daily_behavior_pattern(...)
    service_usage = self.behavior_aggregator.analyze_daily_service_usage(...)
    
    return DailyStatisticsProfile(...)</code></pre>
                    </div>
                    
                    <div class="feature-card">
                        <div class="card-icon">3️⃣</div>
                        <h3>第三步：深度洞察分析</h3>
                        <pre><code class="language-python">async def extract_deep_insight(self, ...):
    # 1. TrustCall 长期语义分析
    semantic_analysis = await self._extract_longterm_semantic_analysis(...)
    
    # 2. 数据挖掘和统计
    behavior_pattern = self.behavior_aggregator.analyze_longterm_behavior_pattern(...)
    travel_pattern = self.data_analyzer.analyze_travel_pattern(...)
    value_score, retention_risk, upsell_potential = self.data_analyzer.calculate_value_metrics(...)
    
    return DeepInsightProfile(...)</code></pre>
                    </div>
                </div>
            </section>

            <section id="dataflow">
                <h2>📊 数据流示意</h2>
                
                <div class="architecture-diagram">
                    <div class="arch-layer">
                        <h4>数据输入层</h4>
                        <div class="arch-components">
                            <span class="component">对话历史</span>
                            <span class="component">→</span>
                            <span class="component">HybridProfileExtractor</span>
                        </div>
                    </div>
                    
                    <div class="arch-layer">
                        <h4>处理分流层</h4>
                        <div class="arch-components">
                            <span class="component">TrustCall 语义提取</span>
                            <span class="component">+</span>
                            <span class="component">数据统计计算</span>
                        </div>
                    </div>
                    
                    <div class="arch-layer">
                        <h4>结果汇聚层</h4>
                        <div class="arch-components">
                            <span class="component">SemanticExtractionResult</span>
                            <span class="component">SessionMetrics</span>
                            <span class="component">ServiceInteraction</span>
                            <span class="component">TechnicalContext</span>
                        </div>
                    </div>
                    
                    <div class="arch-layer">
                        <h4>转换组装层</h4>
                        <div class="arch-components">
                            <span class="component">ContentAnalysis 转换</span>
                            <span class="component">→</span>
                            <span class="component">SingleSessionProfile</span>
                        </div>
                    </div>
                    
                    <div class="arch-layer">
                        <h4>聚合分析层</h4>
                        <div class="arch-components">
                            <span class="component">多个会话画像</span>
                            <span class="component">→</span>
                            <span class="component">BehaviorAggregator</span>
                            <span class="component">→</span>
                            <span class="component">DailyStatisticsProfile</span>
                        </div>
                    </div>
                    
                    <div class="arch-layer">
                        <h4>深度洞察层</h4>
                        <div class="arch-components">
                            <span class="component">多个每日画像</span>
                            <span class="component">→</span>
                            <span class="component">深度分析</span>
                            <span class="component">→</span>
                            <span class="component">DeepInsightProfile</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="advantages">
                <h2>🎯 核心优势</h2>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="card-icon">🎯</div>
                        <h3>1. 职责清晰</h3>
                        <ul>
                            <li>TrustCall: 专注语义理解</li>
                            <li>数据分析: 专注统计计算</li>
                            <li>各司其职，避免混淆</li>
                        </ul>
                    </div>
                    
                    <div class="feature-card">
                        <div class="card-icon">✅</div>
                        <h3>2. 准确性提升</h3>
                        <ul>
                            <li>语义信息通过 LLM 准确提取</li>
                            <li>统计指标通过算法精确计算</li>
                            <li>避免用 AI 做简单计算的错误</li>
                        </ul>
                    </div>
                    
                    <div class="feature-card">
                        <div class="card-icon">⚡</div>
                        <h3>3. 性能优化</h3>
                        <ul>
                            <li>减少不必要的 LLM 调用</li>
                            <li>大部分指标通过本地计算获得</li>
                            <li>提高处理速度和稳定性</li>
                        </ul>
                    </div>
                    
                    <div class="feature-card">
                        <div class="card-icon">🔧</div>
                        <h3>4. 可维护性</h3>
                        <ul>
                            <li>组件模块化设计</li>
                            <li>易于测试和调试</li>
                            <li>便于功能扩展</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="usage">
                <h2>🔧 使用示例</h2>
                
                <h3>触发会话画像提取</h3>
                <pre><code class="language-python"># 通过 memory_manager 触发
result = await memory_manager.trigger_session_profile_extraction(
    application_id="airport_service",
    user_id="user_001",
    run_id="session_001"
)

# 内部调用混合提取器
extractor = hybrid_profile_extractor
session_profile = await extractor.extract_session_profile(...)</code></pre>

                <h3>每日聚合</h3>
                <pre><code class="language-python"># 完全基于统计
daily_profile = await extractor.extract_daily_profile(
    user_id="user_001",
    date="2024-12-01",
    session_profiles=session_list
)</code></pre>

                <h3>深度分析</h3>
                <pre><code class="language-python"># 语义分析 + 数据挖掘
deep_profile = await extractor.extract_deep_insight(
    user_id="user_001",
    daily_profiles=daily_list,
    analysis_period="30天"
)</code></pre>
            </section>

            <section id="expectations">
                <h2>📈 效果预期</h2>
                
                <div class="quick-start-grid">
                    <div class="quick-start-item">
                        <h3>提取准确性</h3>
                        <p>TrustCall 专注语义，避免误判</p>
                    </div>
                    <div class="quick-start-item">
                        <h3>计算效率</h3>
                        <p>统计指标本地计算，响应快速</p>
                    </div>
                    <div class="quick-start-item">
                        <h3>成本控制</h3>
                        <p>减少不必要的 LLM 调用</p>
                    </div>
                    <div class="quick-start-item">
                        <h3>扩展性</h3>
                        <p>组件化设计，易于添加新功能</p>
                    </div>
                </div>
            </section>

            <section id="future">
                <h2>🔮 未来扩展</h2>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="card-icon">⚙️</div>
                        <h3>1. 规则引擎</h3>
                        <p>增强数据分析组件的规则配置</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="card-icon">🤖</div>
                        <h3>2. 机器学习</h3>
                        <p>在统计分析中引入 ML 模型</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="card-icon">⚡</div>
                        <h3>3. 实时分析</h3>
                        <p>支持流式数据处理</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="card-icon">🎥</div>
                        <h3>4. 多模态</h3>
                        <p>支持图片、语音等多模态输入</p>
                    </div>
                </div>
            </section>

            <section id="implementation-details">
                <h2>🛠️ 实现细节</h2>
                
                <h3>技术栈架构</h3>
                <div class="architecture-diagram">
                    <div class="arch-layer">
                        <h4>应用层</h4>
                        <div class="arch-components">
                            <span class="component">FastAPI</span>
                            <span class="component">WebSocket</span>
                            <span class="component">Pydantic</span>
                        </div>
                    </div>
                    
                    <div class="arch-layer">
                        <h4>业务逻辑层</h4>
                        <div class="arch-components">
                            <span class="component">LangGraph</span>
                            <span class="component">HybridProfileExtractor</span>
                            <span class="component">MemoryManager</span>
                        </div>
                    </div>
                    
                    <div class="arch-layer">
                        <h4>AI 服务层</h4>
                        <div class="arch-components">
                            <span class="component">TrustCall API</span>
                            <span class="component">向量数据库</span>
                            <span class="component">嵌入模型</span>
                        </div>
                    </div>
                    
                    <div class="arch-layer">
                        <h4>数据存储层</h4>
                        <div class="arch-components">
                            <span class="component">PostgreSQL</span>
                            <span class="component">ChromaDB</span>
                            <span class="component">Redis Cache</span>
                        </div>
                    </div>
                </div>

                <h3>性能优化策略</h3>
                <div class="features-grid">
                    <div class="feature-card">
                        <h3>并发处理</h3>
                        <ul>
                            <li>异步 I/O 处理</li>
                            <li>连接池管理</li>
                            <li>任务队列优化</li>
                        </ul>
                    </div>
                    
                    <div class="feature-card">
                        <h3>缓存策略</h3>
                        <ul>
                            <li>Redis 分层缓存</li>
                            <li>查询结果缓存</li>
                            <li>热数据预加载</li>
                        </ul>
                    </div>
                    
                    <div class="feature-card">
                        <h3>资源管理</h3>
                        <ul>
                            <li>内存使用监控</li>
                            <li>数据库连接优化</li>
                            <li>API 调用限流</li>
                        </ul>
                    </div>
                </div>

                <h3>监控和可观测性</h3>
                <pre><code class="language-python"># 性能监控示例
import time
import logging
from functools import wraps

def monitor_performance(func):
    @wraps(func)
    async def wrapper(*args, **kwargs):
        start_time = time.time()
        try:
            result = await func(*args, **kwargs)
            execution_time = time.time() - start_time
            logging.info(f"{func.__name__} executed in {execution_time:.2f}s")
            return result
        except Exception as e:
            execution_time = time.time() - start_time
            logging.error(f"{func.__name__} failed after {execution_time:.2f}s: {e}")
            raise
    return wrapper</code></pre>
            </section>

            <div style="text-align: center; margin: 3rem 0;">
                <p><em>这个新架构完全符合设计理念：<strong>TrustCall 负责语义，数据分析负责统计，两者结合形成完整画像</strong>。</em></p>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>文档</h4>
                    <ul>
                        <li><a href="api-docs.html">API 文档</a></li>
                        <li><a href="user-profile.html">用户画像</a></li>
                        <li><a href="architecture.html">系统架构</a></li>
                        <li><a href="memory-filter.html">智能记忆</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>资源</h4>
                    <ul>
                        <li><a href="#examples">使用示例</a></li>
                        <li><a href="#tutorials">教程指南</a></li>
                        <li><a href="#changelog">更新日志</a></li>
                        <li><a href="#support">技术支持</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>关于</h4>
                    <ul>
                        <li><a href="#about">项目介绍</a></li>
                        <li><a href="#team">开发团队</a></li>
                        <li><a href="#license">开源许可</a></li>
                        <li><a href="#contact">联系我们</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 智能客服系统. 版权所有.</p>
            </div>
        </div>
    </footer>

    <script src="assets/js/main.js"></script>
</body>
</html>
