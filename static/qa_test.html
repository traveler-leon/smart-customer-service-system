<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QAæ¥å£æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section {
            background: white;
            margin-bottom: 20px;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 8px rgba(116, 185, 255, 0.3);
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .qa-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #fafafa;
        }

        .qa-item {
            background: white;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .qa-item h4 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .qa-item p {
            margin-bottom: 5px;
        }

        .qa-item .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .tag {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 11px;
        }

        .delete-btn:hover {
            background: #ee5a52;
        }

        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-weight: bold;
        }

        .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .col {
            flex: 1;
            min-width: 300px;
        }

        .stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }

        .stats h3 {
            margin-bottom: 10px;
        }

        .count {
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>QAæ¥å£æµ‹è¯•é¡µé¢</h1>
            <p>æµ‹è¯•ä¸“å®¶QAçš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½</p>
        </div>

        <div class="stats">
            <h3>å½“å‰QAç»Ÿè®¡</h3>
            <div class="count" id="qaCount">-</div>
        </div>

        <div class="row">
            <div class="col">
                <!-- æ·»åŠ QAéƒ¨åˆ† -->
                <div class="section">
                    <h2>ğŸ“ æ·»åŠ QAå¯¹</h2>
                    <div class="form-group">
                        <label for="question">é—®é¢˜ *</label>
                        <textarea id="question" placeholder="è¯·è¾“å…¥é—®é¢˜å†…å®¹"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="answer">ç­”æ¡ˆ *</label>
                        <textarea id="answer" placeholder="è¯·è¾“å…¥ç­”æ¡ˆå†…å®¹"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="expertId">ä¸“å®¶ID</label>
                        <input type="text" id="expertId" placeholder="ä¾‹å¦‚: expert_001">
                    </div>
                    <div class="form-group">
                        <label for="tags">æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)</label>
                        <input type="text" id="tags" placeholder="ä¾‹å¦‚: å€¼æœº,ç™»æœº,æœåŠ¡">
                    </div>
                    <div class="form-group">
                        <label for="images">å›¾ç‰‡é“¾æ¥ (ç”¨é€—å·åˆ†éš”)</label>
                        <input type="text" id="images" placeholder="ä¾‹å¦‚: http://example.com/image1.jpg">
                    </div>
                    <div class="form-group">
                        <label for="services">æœåŠ¡ (ç”¨é€—å·åˆ†éš”)</label>
                        <input type="text" id="services" placeholder="ä¾‹å¦‚: æœºåœºæœåŠ¡,å®¢æˆ·æœåŠ¡">
                    </div>
                    <button class="btn" onclick="addQA()">æ·»åŠ QAå¯¹</button>
                    <button class="btn btn-secondary" onclick="clearAddForm()">æ¸…ç©ºè¡¨å•</button>
                    <div id="addResult" class="result" style="display: none;"></div>
                </div>

                <!-- æ‰¹é‡æ·»åŠ QAéƒ¨åˆ† -->
                <div class="section">
                    <h2>ğŸ“‹ æ‰¹é‡æ·»åŠ QAå¯¹</h2>
                    <div class="form-group">
                        <label for="batchQA">æ‰¹é‡QA (JSONæ ¼å¼)</label>
                        <textarea id="batchQA" placeholder='[{"question":"é—®é¢˜1","answer":"ç­”æ¡ˆ1","tags":["æ ‡ç­¾1"],"images":[],"services":[],"extra_fields":{"expert_id":"expert_001"}}]' style="min-height: 150px;"></textarea>
                    </div>
                    <button class="btn" onclick="addBatchQA()">æ‰¹é‡æ·»åŠ </button>
                    <button class="btn btn-secondary" onclick="fillSampleBatch()">å¡«å……ç¤ºä¾‹æ•°æ®</button>
                    <div id="batchResult" class="result" style="display: none;"></div>
                </div>
            </div>

            <div class="col">
                <!-- è·å–æ‰€æœ‰QAéƒ¨åˆ† -->
                <div class="section">
                    <h2>ğŸ“š æ‰€æœ‰QAåˆ—è¡¨</h2>
                    <button class="btn" onclick="getAllQA()">åˆ·æ–°QAåˆ—è¡¨</button>
                    <button class="btn btn-secondary" onclick="exportQA()">å¯¼å‡ºä¸ºJSON</button>
                    <div class="loading" id="loading">æ­£åœ¨åŠ è½½...</div>
                    <div id="qaList" class="qa-list" style="display: none;"></div>
                    <div id="getAllResult" class="result" style="display: none;"></div>
                </div>

                <!-- ç³»ç»Ÿä¿¡æ¯éƒ¨åˆ† -->
                <div class="section">
                    <h2>ğŸ”§ ç³»ç»Ÿä¿¡æ¯</h2>
                    <button class="btn btn-secondary" onclick="getSystemInfo()">è·å–ç³»ç»Ÿä¿¡æ¯</button>
                    <button class="btn btn-secondary" onclick="pingSystem()">å¥åº·æ£€æŸ¥</button>
                    <div id="systemResult" class="result" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/text2qa';
        let allQAData = [];

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–QAåˆ—è¡¨
        window.onload = function() {
            getAllQA();
            getSystemInfo();
        };

        // æ·»åŠ å•ä¸ªQA
        async function addQA() {
            const question = document.getElementById('question').value.trim();
            const answer = document.getElementById('answer').value.trim();
            
            if (!question || !answer) {
                showResult('addResult', 'è¯·å¡«å†™é—®é¢˜å’Œç­”æ¡ˆ', 'error');
                return;
            }

            const expertId = document.getElementById('expertId').value.trim();
            const tags = document.getElementById('tags').value.trim().split(',').filter(t => t.trim()).map(t => t.trim());
            const images = document.getElementById('images').value.trim().split(',').filter(i => i.trim()).map(i => i.trim());
            const services = document.getElementById('services').value.trim().split(',').filter(s => s.trim()).map(s => s.trim());

            const qaData = {
                question: question,
                answer: answer,
                tags: tags,
                images: images,
                services: services,
                extra_fields: {
                    expert_id: expertId || '',
                    application_id: 'ä¸»æ™ºèƒ½å®¢æœ'
                }
            };

            try {
                const response = await fetch(`${API_BASE}/qa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(qaData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('addResult', `æ·»åŠ æˆåŠŸï¼\nä¸“å®¶è®°å¿†ID: ${result.data.expert_memory_id}\nRedis ID: ${result.data.redis_qa_id}`, 'success');
                    clearAddForm();
                    getAllQA(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showResult('addResult', `æ·»åŠ å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('addResult', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‰¹é‡æ·»åŠ QA
        async function addBatchQA() {
            const batchText = document.getElementById('batchQA').value.trim();
            
            if (!batchText) {
                showResult('batchResult', 'è¯·è¾“å…¥æ‰¹é‡QAæ•°æ®', 'error');
                return;
            }

            try {
                const qaList = JSON.parse(batchText);
                
                const batchData = {
                    qa_pairs: qaList
                };

                const response = await fetch(`${API_BASE}/qa/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(batchData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('batchResult', `æ‰¹é‡æ·»åŠ å®Œæˆï¼\næˆåŠŸ: ${result.data.success_count}\nå¤±è´¥: ${result.data.failed_count}`, 'success');
                    getAllQA(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showResult('batchResult', `æ‰¹é‡æ·»åŠ å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('batchResult', `æ•°æ®æ ¼å¼é”™è¯¯æˆ–è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–æ‰€æœ‰QA
        async function getAllQA() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('qaList').style.display = 'none';
            document.getElementById('getAllResult').style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/qa`);
                const result = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                if (result.success) {
                    allQAData = result.data || [];
                    displayQAList(allQAData);
                    updateQACount(allQAData.length);
                    showResult('getAllResult', `è·å–æˆåŠŸï¼Œå…± ${allQAData.length} æ¡QA`, 'success');
                } else {
                    showResult('getAllResult', `è·å–å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showResult('getAllResult', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ é™¤QA
        async function deleteQA(qaId, question) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªQAå¯¹å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/qa`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: qaId,
                        query: question
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    getAllQA(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert(`åˆ é™¤å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºQAåˆ—è¡¨
        function displayQAList(qaList) {
            const qaListDiv = document.getElementById('qaList');
            
            if (qaList.length === 0) {
                qaListDiv.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— QAæ•°æ®</p>';
            } else {
                qaListDiv.innerHTML = qaList.map(qa => `
                    <div class="qa-item">
                        <button class="delete-btn" onclick="deleteQA('${qa.id}', '${qa.question.replace(/'/g, "\\'")}')">åˆ é™¤</button>
                        <h4>é—®é¢˜: ${escapeHtml(qa.question)}</h4>
                        <p><strong>ç­”æ¡ˆ:</strong> ${escapeHtml(qa.answer)}</p>
                        <p><strong>ä¸“å®¶ID:</strong> ${qa.extra_fields?.expert_id || 'æ— '}</p>
                        <p><strong>åº”ç”¨ID:</strong> ${qa.extra_fields?.application_id || 'æ— '}</p>
                        <p><strong>å›¾ç‰‡:</strong> ${qa.images || 'æ— '}</p>
                        <p><strong>è®°å¿†ID:</strong> ${qa.id}</p>
                        ${qa.tags && qa.tags.length > 0 ? `
                            <div class="tags">
                                ${qa.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                            </div>
                        ` : ''}
                        ${qa.services && qa.services.length > 0 ? `
                            <p><strong>æœåŠ¡:</strong> ${qa.services.join(', ')}</p>
                        ` : ''}
                    </div>
                `).join('');
            }
            
            qaListDiv.style.display = 'block';
        }

        // è·å–ç³»ç»Ÿä¿¡æ¯
        async function getSystemInfo() {
            try {
                const response = await fetch(`${API_BASE}/count`);
                const result = await response.json();
                
                if (result.success) {
                    showResult('systemResult', `ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯:\næ€»QAæ•°é‡: ${result.data.total_count}\nä¸“å®¶åº“æ•°é‡: ${result.data.expert_count}\nRedisæ•°é‡: ${result.data.redis_count}`, 'success');
                } else {
                    showResult('systemResult', `è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('systemResult', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¥åº·æ£€æŸ¥
        async function pingSystem() {
            try {
                const response = await fetch(`${API_BASE}/ping`);
                const result = await response.json();
                
                if (result.success) {
                    const healthInfo = result.data;
                    showResult('systemResult', `å¥åº·æ£€æŸ¥ç»“æœ:\næ•´ä½“å¥åº·: ${healthInfo.overall_health ? 'æ­£å¸¸' : 'å¼‚å¸¸'}\nä¸“å®¶åº“: ${healthInfo.expert_memory_alive ? 'æ­£å¸¸' : 'å¼‚å¸¸'}\nRedis: ${healthInfo.redis_alive ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`, healthInfo.overall_health ? 'success' : 'error');
                } else {
                    showResult('systemResult', `å¥åº·æ£€æŸ¥å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('systemResult', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¯¼å‡ºQAä¸ºJSON
        function exportQA() {
            if (allQAData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const dataStr = JSON.stringify(allQAData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `qa_export_${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
        }

        // å¡«å……ç¤ºä¾‹æ•°æ®
        function fillSampleBatch() {
            const sampleData = [
                {
                    "question": "å¦‚ä½•åŠç†ç™»æœºæ‰‹ç»­ï¼Ÿ",
                    "answer": "æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åŠç†ç™»æœºæ‰‹ç»­ï¼š1. ç½‘ä¸Šå€¼æœº 2. æ‰‹æœºAppå€¼æœº 3. æœºåœºè‡ªåŠ©å€¼æœº 4. äººå·¥æŸœå°å€¼æœº",
                    "tags": ["å€¼æœº", "ç™»æœº", "æœåŠ¡æµç¨‹"],
                    "images": ["https://example.com/checkin.jpg"],
                    "services": ["æœºåœºæœåŠ¡", "å®¢æˆ·æœåŠ¡"],
                    "extra_fields": {"expert_id": "expert_001"}
                },
                {
                    "question": "å¯ä»¥æºå¸¦å¤šå°‘è¡Œæï¼Ÿ",
                    "answer": "è¡Œæé™åˆ¶å› èˆªç©ºå…¬å¸å’Œèˆ±ä½è€Œå¼‚ã€‚ä¸€èˆ¬ç»æµèˆ±å¯å…è´¹æ‰˜è¿20å…¬æ–¤è¡Œæï¼Œå•†åŠ¡èˆ±30å…¬æ–¤ï¼Œå¤´ç­‰èˆ±40å…¬æ–¤ã€‚éšèº«æºå¸¦è¡Œæé€šå¸¸é™åˆ¶åœ¨7å…¬æ–¤ä»¥å†…ã€‚",
                    "tags": ["è¡Œæ", "æ‰˜è¿", "é™åˆ¶"],
                    "images": [],
                    "services": ["è¡ŒææœåŠ¡"],
                    "extra_fields": {"expert_id": "expert_002"}
                },
                {
                    "question": "èˆªç­å»¶è¯¯æ€ä¹ˆåŠï¼Ÿ",
                    "answer": "èˆªç­å»¶è¯¯æ—¶ï¼š1. ä¿æŒå†·é™ï¼Œå…³æ³¨èˆªç©ºå…¬å¸é€šçŸ¥ 2. äº†è§£å»¶è¯¯åŸå› å’Œé¢„è®¡èµ·é£æ—¶é—´ 3. ç”³è¯·é¤é£Ÿæˆ–ä½å®¿è¡¥å¿ 4. å¦‚éœ€è¦å¯ç”³è¯·æ”¹ç­¾æˆ–é€€ç¥¨",
                    "tags": ["å»¶è¯¯", "è¡¥å¿", "æ”¹ç­¾"],
                    "images": [],
                    "services": ["å®¢æˆ·æœåŠ¡", "æŠ•è¯‰å¤„ç†"],
                    "extra_fields": {"expert_id": "expert_003"}
                }
            ];
            
            document.getElementById('batchQA').value = JSON.stringify(sampleData, null, 2);
        }

        // æ¸…ç©ºæ·»åŠ è¡¨å•
        function clearAddForm() {
            document.getElementById('question').value = '';
            document.getElementById('answer').value = '';
            document.getElementById('expertId').value = '';
            document.getElementById('tags').value = '';
            document.getElementById('images').value = '';
            document.getElementById('services').value = '';
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // æ›´æ–°QAè®¡æ•°
        function updateQACount(count) {
            document.getElementById('qaCount').textContent = count;
        }

        // è½¬ä¹‰HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
